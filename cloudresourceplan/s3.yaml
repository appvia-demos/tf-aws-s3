apiVersion: cloudresources.appvia.io/v2beta1
kind: CloudResourcePlan
metadata:
  annotations:
  name: appvia-demos-tf-aws-s3
spec:
  allocation:
    type: none
  cloud: aws
  description: Imported from https://github.com/appvia-demos/tf-aws-s3
  enableTemplateAutoUpgrade: false
  enableWatch: false
  inputDefinitions:
  - default: null
    description: ID element _(Rarely used, not included by default)_. A customer identifier,
      indicating who this instance of a resource is for
    name: tenant
    type: string
  - default: []
    description: |
      A list of policy grants for the bucket, taking a list of permissions.
      Conflicts with `acl`. Set `acl` to `null` to use this.
      Deprecated by AWS in favor of bucket policies.
      Automatically disabled if `s3_object_ownership` is set to "BucketOwnerEnforced".
    name: grants
    type: |-
      list(object({
          id          = string
          type        = string
          permissions = list(string)
          uri         = string
        }))
  - default: true
    description: Set to `false` to disable the blocking of new public access lists
      on the bucket
    name: block_public_acls
    type: bool
  - default: []
    description: If provided, all website requests will be redirected to the specified
      host name and protocol
    name: website_redirect_all_requests_to
    type: |-
      list(object({
          host_name = string
          protocol  = string
        }))
  - default: null
    description: |
      The order in which the labels (ID elements) appear in the `id`.
      Defaults to ["namespace", "environment", "stage", "name", "attributes"].
      You can omit any of the 6 labels ("tenant" is the 6th), but at least one must be present.
    name: label_order
    type: list(string)
  - default: []
    description: 'DEPRECATED (use `lifecycle_configuration_rules`): A list of IDs
      to assign to corresponding `lifecycle_rules`'
    name: lifecycle_rule_ids
    type: list(string)
  - default: null
    description: 'DEPRECATED (`use lifecycle_configuration_rules`): A list of lifecycle
      rules'
    name: lifecycle_rules
    type: |-
      list(object({
          prefix  = string
          enabled = bool
          tags    = map(string)

          enable_glacier_transition            = bool
          enable_deeparchive_transition        = bool
          enable_standard_ia_transition        = bool
          enable_current_object_expiration     = bool
          enable_noncurrent_version_expiration = bool

          abort_incomplete_multipart_upload_days         = number
          noncurrent_version_glacier_transition_days     = number
          noncurrent_version_deeparchive_transition_days = number
          noncurrent_version_expiration_days             = number

          standard_transition_days    = number
          glacier_transition_days     = number
          deeparchive_transition_days = number
          expiration_days             = number
        }))
  - default: null
    description: Set to `true` to create an IAM user with permission to access the
      bucket
    name: user_enabled
    type: bool
  - default: null
    description: Permission boundary ARN for the IAM user created to access the bucket.
    name: user_permissions_boundary_arn
    type: string
  - default: []
    description: |
      ID element. Additional attributes (e.g. `workers` or `cluster`) to add to `id`,
      in the order they appear in the list. New attributes are appended to the
      end of the list. The elements of the list are joined by the `delimiter`
      and treated as a single ID element.
    name: attributes
    type: list(string)
  - default: null
    description: 'DEPRECATED (use `s3_replication_rules`): Specifies the replication
      rules for S3 bucket replication if enabled. You must also set s3_replication_enabled
      to true.'
    name: replication_rules
    type: list(any)
  - default: true
    description: Set to `true` to create an IAM Access Key for the created IAM user
    name: access_key_enabled
    type: bool
  - default: []
    description: Specifies the allowed headers, methods, origins and exposed headers
      when using CORS on this bucket
    name: cors_configuration
    type: |-
      list(object({
          id              = optional(string)
          allowed_headers = optional(list(string))
          allowed_methods = optional(list(string))
          allowed_origins = optional(list(string))
          expose_headers  = optional(list(string))
          max_age_seconds = optional(number)
        }))
  - default: null
    description: ID element. Usually an abbreviation of your organization name, e.g.
      'eg' or 'cp', to help ensure generated IDs are globally unique
    name: namespace
    type: string
  - default: null
    description: |
      Controls the letter case of the `tags` keys (label names) for tags generated by this module.
      Does not affect keys of tags passed in via the `tags` input.
      Possible values: `lower`, `title`, `upper`.
      Default value: `title`.
    name: label_key_case
    type: string
  - default: []
    description: |
      List of IAM policy documents (in JSON) that are merged together into the exported document.
      Statements defined in source_policy_documents must have unique SIDs.
      Statement having SIDs that match policy SIDs generated by this module will override them.
    name: source_policy_documents
    type: list(string)
  - default: []
    description: Bucket access logging configuration. Empty list for no logging, list
      of 1 to enable logging.
    name: logging
    type: |-
      list(object({
          bucket_name = string
          prefix      = string
        }))
  - default: []
    description: List of actions to permit `privileged_principal_arns` to perform
      on bucket and bucket prefixes (see `privileged_principal_arns`)
    name: privileged_principal_actions
    type: list(string)
  - default: null
    description: Set to `true` to prevent uploads of unencrypted objects to S3 bucket
    name: allow_encrypted_uploads_only
    type: bool
  - default: true
    description: Set to `false` to disable the ignoring of public access lists on
      the bucket
    name: ignore_public_acls
    type: bool
  - default: null
    description: |
      ID element. Usually the component or solution name, e.g. 'app' or 'jenkins'.
      This is the only ID element not also included as a `tag`.
      The "name" tag is set to the full `id` string. There is no tag with the value of the `name` input.
    name: name
    type: string
  - default: null
    description: |
      Controls the letter case of ID elements (labels) as included in `id`,
      set as tag values, and output by this module individually.
      Does not affect values of tags passed in via the `tags` input.
      Possible values: `lower`, `title`, `upper` and `none` (no transformation).
      Set this to `title` and set `delimiter` to `""` to yield Pascal Case IDs.
      Default value: `lower`.
    name: label_value_case
    type: string
  - default: null
    description: Permissions boundary ARN for the created IAM replication role.
    name: s3_replication_permissions_boundary_arn
    type: string
  - default: []
    description: List of IP addresses to allow to perform all actions to the bucket
    name: source_ip_allow_list
    type: list(string)
  - default: null
    description: |
      When `true`, permits a non-empty S3 bucket to be deleted by first deleting all objects in the bucket.
      THESE OBJECTS ARE NOT RECOVERABLE even if they were versioned and stored in Glacier.
    name: force_destroy
    type: bool
  - default: AES256
    description: The server-side encryption algorithm to use. Valid values are `AES256`
      and `aws:kms`
    name: sse_algorithm
    type: string
  - default: null
    description: |
      Set to `true` to store the created IAM user's access key in SSM Parameter Store,
      `false` to store them in Terraform state as outputs.
      Since Terraform state would contain the secrets in plaintext,
      use of SSM Parameter Store is recommended.
    name: store_access_key_in_ssm
    type: bool
  - default: null
    description: A configuration for S3 object locking. With S3 Object Lock, you can
      store objects using a `write once, read many` (WORM) model. Object Lock can
      help prevent objects from being deleted or overwritten for a fixed amount of
      time or indefinitely.
    name: object_lock_configuration
    type: |-
      object({
          mode  = string # Valid values are GOVERNANCE and COMPLIANCE.
          days  = number
          years = number
        })
  - default: {}
    description: |
      Additional tags (e.g. `{'BusinessUnit': 'XYZ'}`).
      Neither the tag keys nor the tag values will be modified by this module.
    name: tags
    type: map(string)
  - default: []
    description: A list of lifecycle V2 rules
    name: lifecycle_configuration_rules
    type: |-
      list(object({
          enabled = optional(bool, true)
          id      = string

          abort_incomplete_multipart_upload_days = optional(number)

          # `filter_and` is the `and` configuration block inside the `filter` configuration.
          # This is the only place you should specify a prefix.
          filter_and = optional(object({
            object_size_greater_than = optional(number) # integer >= 0
            object_size_less_than    = optional(number) # integer >= 1
            prefix                   = optional(string)
            tags                     = optional(map(string), {})
          }))
          expiration = optional(object({
            date                         = optional(string) # string, RFC3339 time format, GMT
            days                         = optional(number) # integer > 0
            expired_object_delete_marker = optional(bool)
          }))
          noncurrent_version_expiration = optional(object({
            newer_noncurrent_versions = optional(number) # integer > 0
            noncurrent_days           = optional(number) # integer >= 0
          }))
          transition = optional(list(object({
            date          = optional(string) # string, RFC3339 time format, GMT
            days          = optional(number) # integer > 0
            storage_class = optional(string)
            # string/enum, one of GLACIER, STANDARD_IA, ONEZONE_IA, INTELLIGENT_TIERING, DEEP_ARCHIVE, GLACIER_IR.
          })), [])

          noncurrent_version_transition = optional(list(object({
            newer_noncurrent_versions = optional(number) # integer >= 0
            noncurrent_days           = optional(number) # integer >= 0
            storage_class             = optional(string)
            # string/enum, one of GLACIER, STANDARD_IA, ONEZONE_IA, INTELLIGENT_TIERING, DEEP_ARCHIVE, GLACIER_IR.
          })), [])
        }))
  - default: []
    description: Cross-account IAM Role ARNs that will be allowed to perform S3 replication
      to this bucket (for replication within the same AWS account, it's not necessary
      to adjust the bucket policy).
    name: s3_replication_source_roles
    type: list(string)
  - default: null
    description: Set to false to prevent the module from creating any resources
    name: enabled
    type: bool
  - default: null
    description: Specifies the replication rules for S3 bucket replication if enabled.
      You must also set s3_replication_enabled to true.
    name: s3_replication_rules
    type: |-
      list(object({
          id       = optional(string)
          priority = optional(number)
          prefix   = optional(string)
          status   = optional(string, "Enabled")
          # delete_marker_replication { status } had been flattened for convenience
          delete_marker_replication_status = optional(string, "Disabled")
          # Add the configuration as it appears in the resource, for consistency
          # this nested version takes precedence if both are provided.
          delete_marker_replication = optional(object({
            status = string
          }))

          # destination_bucket is specified here rather than inside the destination object because before optional
          # attributes, it made it easier to work with the Terraform type system and create a list of consistent type.
          # It is preserved for backward compatibility, but the nested version takes priority if both are provided.
          destination_bucket = optional(string) # destination bucket ARN, overrides s3_replica_bucket_arn

          destination = object({
            bucket        = optional(string) # destination bucket ARN, overrides s3_replica_bucket_arn
            storage_class = optional(string, "STANDARD")
            # replica_kms_key_id at this level is for backward compatibility, and is overridden by the one in `encryption_configuration`
            replica_kms_key_id = optional(string, "")
            encryption_configuration = optional(object({
              replica_kms_key_id = string
            }))
            access_control_translation = optional(object({
              owner = string
            }))
            # account_id is for backward compatibility, overridden by account
            account_id = optional(string)
            account    = optional(string)
            # For convenience, specifying either metrics or replication_time enables both
            metrics = optional(object({
              event_threshold = optional(object({
                minutes = optional(number, 15) # Currently 15 is the only valid number
              }), { minutes = 15 })
              status = optional(string, "Enabled")
            }), { status = "Disabled" })
            # To preserve backward compatibility, Replication Time Control (RTC) is automatically enabled
            # when metrics are enabled. To enable metrics without RTC, you must explicitly configure
            # replication_time.status = "Disabled".
            replication_time = optional(object({
              time = optional(object({
                minutes = optional(number, 15) # Currently 15 is the only valid number
              }), { minutes = 15 })
              status = optional(string)
            }))
          })

          source_selection_criteria = optional(object({
            replica_modifications = optional(object({
              status = string # Either Enabled or Disabled
            }))
            sse_kms_encrypted_objects = optional(object({
              status = optional(string)
            }))
          }))
          # filter.prefix overrides top level prefix
          filter = optional(object({
            prefix = optional(string)
            tags   = optional(map(string), {})
          }))
        }))
  - default: null
    description: The AWS KMS master key ARN used for the `SSE-KMS` encryption. This
      can only be used when you set the value of `sse_algorithm` as `aws:kms`. The
      default aws/s3 AWS KMS master key is used if this element is absent while the
      `sse_algorithm` is `aws:kms`
    name: kms_master_key_arn
    type: string
  - default: null
    description: |
      A single S3 bucket ARN to use for all replication rules.
      Note: The destination bucket can be specified in the replication rule itself
      (which allows for multiple destinations), in which case it will take precedence over this variable.
    name: s3_replica_bucket_arn
    type: string
  - default: null
    description: Bucket name. If provided, the bucket will be created with this name
      instead of generating the name from the context
    name: bucket_name
    type: string
  - default: ObjectWriter
    description: |
      Specifies the S3 object ownership control.
      Valid values are `ObjectWriter`, `BucketOwnerPreferred`, and 'BucketOwnerEnforced'.
      Defaults to "ObjectWriter" for backwards compatibility, but we recommend setting "BucketOwnerEnforced" instead.
    name: s3_object_ownership
    type: string
  - default: null
    description: |
      Set this to `true` to enable S3 Transfer Acceleration for the bucket.
      Note: When this is set to `false` Terraform does not perform drift detection
      and will not disable Transfer Acceleration if it was enabled outside of Terraform.
      To disable it via Terraform, you must set this to `true` and then to `false`.
      Note: not all regions support Transfer Acceleration.
    name: transfer_acceleration_enabled
    type: bool
  - default: null
    description: |
      Delimiter to be used between ID elements.
      Defaults to `-` (hyphen). Set to `""` to use no delimiter at all.
    name: delimiter
    type: string
  - default: {}
    description: |
      Describe additional descriptors to be output in the `descriptors` output map.
      Map of maps. Keys are names of descriptors. Values are maps of the form
      `{
         format = string
         labels = list(string)
      }`
      (Type is `any` so the map values can later be enhanced to provide additional options.)
      `format` is a Terraform format string to be passed to the `format()` function.
      `labels` is a list of labels, in order, to pass to `format()` function.
      Label values will be normalized before being passed to `format()` so they will be
      identical to how they appear in `id`.
      Default is `{}` (`descriptors` output will be empty).
    name: descriptor_formats
    type: any
  - default: null
    description: Set to `true` to require requests to use Secure Socket Layer (HTTPS/SSL).
      This will explicitly deny access to HTTP requests
    name: allow_ssl_requests_only
    type: bool
  - default: null
    description: Set this to true and specify `s3_replication_rules` to enable replication.
      `versioning_enabled` must also be `true`.
    name: s3_replication_enabled
    type: bool
  - default: []
    description: Specifies the static website hosting configuration object
    name: website_configuration
    type: |-
      list(object({
          index_document = string
          error_document = string
          routing_rules = list(object({
            condition = object({
              http_error_code_returned_equals = string
              key_prefix_equals               = string
            })
            redirect = object({
              host_name               = string
              http_redirect_code      = string
              protocol                = string
              replace_key_prefix_with = string
              replace_key_with        = string
            })
          }))
        }))
  - default: true
    description: Set to `false` to disable the blocking of new public policies on
      the bucket
    name: block_public_policy
    type: bool
  - default: null
    description: |
      Set this to true to use Amazon S3 Bucket Keys for SSE-KMS, which may or may not reduce the number of AWS KMS requests.
      For more information, see: https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-key.html
    name: bucket_key_enabled
    type: bool
  - default: null
    description: ID element. Usually used for region e.g. 'uw2', 'us-west-2', OR role
      'prod', 'staging', 'dev', 'UAT'
    name: environment
    type: string
  - default: null
    description: ID element. Usually used to indicate role, e.g. 'prod', 'staging',
      'source', 'build', 'test', 'deploy', 'release'
    name: stage
    type: string
  - default: null
    description: |
      Terraform regular expression (regex) string.
      Characters matching the regex will be removed from the ID elements.
      If not set, `"/[^a-zA-Z0-9-]/"` is used to remove all characters other than hyphens, letters and digits.
    name: regex_replace_chars
    type: string
  - default: null
    description: |
      Limit `id` to this many characters (minimum 6).
      Set to `0` for unlimited length.
      Set to `null` for keep the existing setting, which defaults to `0`.
      Does not affect `id_full`.
    name: id_length_limit
    type: number
  - default: true
    description: A state of versioning. Versioning is a means of keeping multiple
      variants of an object in the same bucket
    name: versioning_enabled
    type: bool
  - default: {}
    description: |
      Additional key-value pairs to add to each map in `tags_as_list_of_maps`. Not added to `tags` or `id`.
      This is for some rare cases where resources want additional configuration of tags
      and therefore take a list of maps with tag key, value, and additional configuration.
    name: additional_tag_map
    type: map(string)
  - default: /s3_user/
    description: The base path for SSM parameters where created IAM user's access
      key is stored
    name: ssm_base_path
    type: string
  - default:
    - s3:PutObject
    - s3:PutObjectAcl
    - s3:GetObject
    - s3:DeleteObject
    - s3:ListBucket
    - s3:ListBucketMultipartUploads
    - s3:GetBucketLocation
    - s3:AbortMultipartUpload
    description: List of actions the user is permitted to perform on the S3 bucket
    name: allowed_bucket_actions
    type: list(string)
  - default: true
    description: Set to `false` to disable the restricting of making the bucket public
    name: restrict_public_buckets
    type: bool
  - default:
      additional_tag_map: {}
      attributes: []
      descriptor_formats: {}
      enabled: true
      label_order: []
      labels_as_tags:
      - unset
      tags: {}
    description: |
      Single object for setting entire context at once.
      See description of individual variables for details.
      Leave string and numeric variables as `null` to use default value.
      Individual variable settings (non-null) override settings in context object,
      except for attributes, tags, and additional_tag_map, which are merged.
    name: context
    type: any
  - default:
    - default
    description: |
      Set of labels (ID elements) to include as tags in the `tags` output.
      Default is to include all labels.
      Tags with empty values will not be included in the `tags` output.
      Set to `[]` to suppress all generated tags.
      **Notes:**
        The value of the `name` tag, if included, will be the `id`, not the `name`.
        Unlike other `null-label` inputs, the initial setting of `labels_as_tags` cannot be
        changed in later chained modules. Attempts to change it will be silently ignored.
    name: labels_as_tags
    type: set(string)
  - default: private
    description: |
      The [canned ACL](https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl) to apply.
      Deprecated by AWS in favor of bucket policies.
      Automatically disabled if `s3_object_ownership` is set to "BucketOwnerEnforced".
      Defaults to "private" for backwards compatibility, but we recommend setting `s3_object_ownership` to "BucketOwnerEnforced" instead.
    name: acl
    type: string
  - default: []
    description: |
      List of maps. Each map has a key, an IAM Principal ARN, whose associated value is
      a list of S3 path prefixes to grant `privileged_principal_actions` permissions for that principal,
      in addition to the bucket itself, which is automatically included. Prefixes should not begin with '/'.
    name: privileged_principal_arns
    type: list(map(list(string)))
  outputs:
  - description: Normalized IAM user name
    name: user_name
  - description: |
      The secret access key will be output if created and not stored in SSM. However, the secret access key, if created,
      will be written to the Terraform state file unencrypted, regardless of any other settings.
      See the [Terraform documentation](https://www.terraform.io/docs/state/sensitive-data.html) for more details.
    name: secret_access_key
    sensitive: true
  - description: The bucket region-specific domain name
    name: bucket_regional_domain_name
  - description: Bucket Name (aka ID)
    name: bucket_id
  - description: Bucket ARN
    name: bucket_arn
  - description: Is module enabled
    name: enabled
  - description: The ARN assigned by AWS for the user
    name: user_arn
  - description: The bucket website endpoint, if website is enabled
    name: bucket_website_endpoint
  - description: Is user creation enabled
    name: user_enabled
  - description: |
      The access key ID, if `var.user_enabled && var.access_key_enabled`.
      While sensitive, it does not need to be kept secret, so this is output regardless of `var.store_access_key_in_ssm`.
    name: access_key_id
    sensitive: true
  - description: The SSM Path under which the S3 User's access key ID is stored
    name: access_key_id_ssm_path
  - description: The ARN of the replication IAM Role
    name: replication_role_arn
  - description: The SSM Path under which the S3 User's secret access key is stored
    name: secret_access_key_ssm_path
  - description: FQDN of bucket
    name: bucket_domain_name
  - description: The bucket website domain, if website is enabled
    name: bucket_website_domain
  - description: Bucket region
    name: bucket_region
  - description: The user unique ID assigned by AWS
    name: user_unique_id
  policies:
  - editable: false
    path: tenant
  - editable: false
    path: grants
  - editable: false
    path: block_public_acls
  - editable: false
    path: website_redirect_all_requests_to
  - editable: false
    path: label_order
  - editable: false
    path: lifecycle_rule_ids
  - editable: false
    path: lifecycle_rules
  - editable: false
    path: user_enabled
  - editable: false
    path: user_permissions_boundary_arn
  - editable: false
    path: attributes
  - editable: false
    path: replication_rules
  - editable: false
    path: access_key_enabled
  - editable: false
    path: cors_configuration
  - editable: false
    path: namespace
  - editable: false
    path: label_key_case
  - editable: false
    path: source_policy_documents
  - editable: false
    path: logging
  - editable: false
    path: privileged_principal_actions
  - editable: false
    path: allow_encrypted_uploads_only
  - editable: false
    path: ignore_public_acls
  - editable: false
    path: name
  - editable: false
    path: label_value_case
  - editable: false
    path: s3_replication_permissions_boundary_arn
  - editable: false
    path: source_ip_allow_list
  - editable: false
    path: force_destroy
  - editable: false
    path: sse_algorithm
  - editable: false
    path: store_access_key_in_ssm
  - editable: false
    path: object_lock_configuration
  - editable: false
    path: tags
  - editable: false
    path: lifecycle_configuration_rules
  - editable: false
    path: s3_replication_source_roles
  - editable: false
    path: enabled
  - editable: false
    path: s3_replication_rules
  - editable: false
    path: kms_master_key_arn
  - editable: false
    path: s3_replica_bucket_arn
  - editable: false
    path: bucket_name
  - editable: false
    path: s3_object_ownership
  - editable: false
    path: transfer_acceleration_enabled
  - editable: false
    path: delimiter
  - editable: false
    path: descriptor_formats
  - editable: false
    path: allow_ssl_requests_only
  - editable: false
    path: s3_replication_enabled
  - editable: false
    path: website_configuration
  - editable: false
    path: block_public_policy
  - editable: false
    path: bucket_key_enabled
  - editable: false
    path: environment
  - editable: false
    path: stage
  - editable: false
    path: regex_replace_chars
  - editable: false
    path: id_length_limit
  - editable: false
    path: versioning_enabled
  - editable: false
    path: additional_tag_map
  - editable: false
    path: ssm_base_path
  - editable: false
    path: allowed_bucket_actions
  - editable: false
    path: restrict_public_buckets
  - editable: false
    path: context
  - editable: false
    path: labels_as_tags
  - editable: false
    path: acl
  - editable: false
    path: privileged_principal_arns
  template:
    revision: v0.0.1
    source: https://github.com/appvia-demos/tf-aws-s3
    variables: {}
